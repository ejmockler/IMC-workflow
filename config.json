{
  "project_name": "imc_analysis",
  "project_id": "kidney_healing_2024",
  "project_version": "1.0",
  "data": {
    "raw_data_dir": "data/241218_IMC_Alun",
    "metadata_file": "data/241218_IMC_Alun/Metadata-Table 1.csv",
    "file_pattern": "*.txt"
  },
  "channels": {
    "protein_channels": [
      "CD45", "CD11b", "Ly6G", "CD140a", "CD140b", 
      "CD31", "CD34", "CD206", "CD44"
    ],
    "dna_channels": ["DNA1", "DNA2"],
    "background_channel": "190BCKG",
    "calibration_channels": ["130Ba", "131Xe"],
    "carrier_gas_channel": "80ArAr",
    "excluded_channels": [
      "Start_push", "End_push", "Pushes_duration", "Z"
    ],
    "coordinate_channels": ["X", "Y"]
  },
  "channel_groups": {
    "immune_markers": {
      "pan_leukocyte": ["CD45"],
      "myeloid": ["CD11b", "Ly6G", "CD206"]
    },
    "stromal_markers": {
      "fibroblasts": ["CD140a", "CD140b"]
    },
    "vascular_markers": {
      "endothelial": ["CD31", "CD34"]
    },
    "adhesion_markers": ["CD44"]
  },
  "processing": {
    "background_correction": {
      "enabled": true,
      "method": "pixel_subtraction",
      "clip_negative": true
    },
    "dna_processing": {
      "resolution_um": 1.0,
      "arcsinh_transform": {
        "enabled": true,
        "noise_floor_method": "percentile",
        "noise_floor_percentile": 10,
        "cofactor_multiplier": 3,
        "comment": "Conservative cofactor to preserve gradients while handling dynamic range"
      },
      "normalization": {
        "enabled": false,
        "comment": "Disabled - ArcSinh alone is sufficient, double transformation destroys gradients"
      },
      "slic_adjustments": {
        "compactness_multiplier": 1.0,
        "sigma_multiplier": 1.0,
        "comment": "No adjustment - trust SLIC with properly transformed data"
      },
      "tissue_threshold": 0.1,
      "tissue_threshold_comment": "Threshold for tissue detection after ArcSinh transform"
    },
    "arcsinh_transform": {
      "optimization_method": "percentile",
      "percentile_threshold": 5.0
    },
    "normalization": {
      "method": "standardize",
      "per_channel": true
    }
  },
  "segmentation": {
    "method": "slic",
    "methods_to_compare": ["slic", "square"],
    "slic_input_channels": ["DNA1", "DNA2"],
    "slic_params": {
      "n_segments_per_mm2": 2500,
      "compactness": 10.0,
      "sigma": 1.5
    },
    "square_params": {
      "bin_sizes_um": [10.0, 20.0, 40.0]
    },
    "scales_um": [10.0, 20.0, 40.0],
    "enable_comparison": false
  },
  "kidney_experiment": {
    "superpixel_scales": {
      "capillary": {
        "target_size_um": 10,
        "description": "Capillary network resolution - peritubular capillaries",
        "biological_features": ["CD31+ endothelial networks", "immune cell interactions"]
      },
      "tubular": {
        "target_size_um": 75,
        "description": "Tubular cross-sections and microenvironments", 
        "biological_features": ["tubular-interstitial interface", "local immune infiltration"]
      },
      "architectural": {
        "target_size_um": 200,
        "description": "Glomerular and cortical architectural units",
        "biological_features": ["glomerular tufts", "cortical organization"]
      }
    },
    "anatomical_validation": {
      "cortex_signatures": {
        "expected_high": ["CD31", "CD34"],
        "expected_pattern": "glomerular_enrichment"
      },
      "medulla_signatures": {
        "expected_high": ["CD140a"],
        "expected_pattern": "interstitial_distribution"
      }
    },
    "temporal_expectations": {
      "day_1": {
        "primary_response": "neutrophil_recruitment",
        "key_markers": ["Ly6G", "CD11b"],
        "spatial_pattern": "focal_infiltration"
      },
      "day_3": {
        "primary_response": "macrophage_activation", 
        "key_markers": ["CD206", "CD11b"],
        "spatial_pattern": "expanding_inflammation"
      },
      "day_7": {
        "primary_response": "resolution_or_fibrosis",
        "key_markers": ["CD140a", "CD140b", "CD206"],
        "spatial_pattern": "organized_repair"
      }
    }
  },
  "analysis": {
    "analyze_regions_separately": true,
    "anatomical_regions": ["Cortex", "Medulla"],
    "clustering": {
      "n_clusters": 8,
      "optimization_method": "comprehensive",
      "k_range": [2, 12],
      "random_state": 42,
      "stability_testing": {
        "enabled": false,
        "subsample_ratios": [0.9, 1.0],
        "n_iterations": 10
      },
      "morphology_validation": {
        "enabled": false,
        "known_markers": {
          "immune": ["CD45", "CD11b", "Ly6G", "CD206"],
          "stromal": ["CD140a", "CD140b"],
          "vascular": ["CD31", "CD34"]
        }
      }
    },
    "batch_correction": {
      "enabled": true,
      "method": "sham_anchored",
      "sham_condition": "Sham",
      "sham_timepoint": 0,
      "group_by": ["Injury Day", "Mouse"],
      "bootstrap_confidence": {
        "enabled": true,
        "n_iterations": 1000,
        "confidence_level": 0.95
      },
      "validation": {
        "detect_batch_effects": true,
        "compute_improvement_metrics": true
      }
    }
  },
  "quality_control": {
    "monitor_calibration": true,
    "calibration_cv_threshold": 0.2,
    "monitor_carrier_gas": true,
    "min_carrier_gas_signal": 100,
    "generate_qc_plots": true,
    "thresholds": {
      "total_ion_counts": {
        "min_tic_percentile": 10,
        "max_low_tic_pixels_percent": 20,
        "description": "TIC monitoring - flags ROIs with acquisition issues"
      },
      "calibration_drift": {
        "max_drift_percent": 5,
        "max_cv_across_rois": 0.3,
        "description": "Calibration stability across entire acquisition run"
      },
      "segmentation_quality": {
        "min_dna_signal": 1.0,
        "min_tissue_coverage_percent": 10,
        "dna_threshold_std_multiplier": 2.0,
        "description": "DNA signal quality for SLIC segmentation feasibility"
      },
      "signal_to_background": {
        "min_snr": 3.0,
        "description": "Minimum signal-to-background ratio for protein channels"
      },
      "spatial_artifacts": {
        "edge_distance_fraction": 0.1,
        "significance_threshold": 0.01,
        "fold_change_threshold": 2.0,
        "description": "Detection of edge effects and spatial artifacts"
      }
    }
  },
  "output": {
    "results_dir": "results/cross_sectional_kidney_injury",
    "roi_results_dir": "roi_results",
    "qc_dir": "quality_control",
    "save_intermediate": true,
    "save_format": "hdf5",
    "compression": true,
    "include_provenance": true,
    "figures": {
      "generate_comparison_plots": false,
      "multi_scale_visualization": false,
      "batch_effect_plots": false,
      "clustering_validation_plots": false,
      "temporal_progression_plots": false,
      "cross_sectional_comparisons": false
    },
    "reports": {
      "methods_summary": true,
      "parameter_sensitivity": false,
      "computational_performance": true
    }
  },
  "performance": {
    "parallel_processes": 1,
    "memory_limit_gb": 8.0,
    "chunk_size": 5000,
    "enable_profiling": false,
    "cache_intermediate": false,
    "process_sequentially": true,
    "garbage_collect_frequency": 1
  },
  "validation": {
    "method": "comprehensive",
    "reference_channels": ["DNA1", "DNA2"],
    "quality_metrics": [
      "compactness",
      "boundary_adherence", 
      "spatial_coherence",
      "size_consistency"
    ],
    "biological_correspondence": {
      "enabled": true,
      "metrics": ["enrichment", "colocalization"]
    },
    "visual_validation": {
      "enabled": true,
      "generate_plots": true,
      "plot_formats": ["png"],
      "dpi": 150
    }
  },
  "visualization": {
    "validation_plots": {
      "primary_markers": {
        "immune_markers": "CD45",
        "vascular_markers": "CD31",
        "stromal_markers": "CD140a"
      },
      "colormaps": {
        "immune_markers": "Reds",
        "vascular_markers": "Blues", 
        "stromal_markers": "Greens",
        "adhesion_markers": "Purples",
        "default": "viridis"
      },
      "max_additional_channels": 5,
      "layout": {
        "figsize": [20, 12],
        "top_row_panels": 4,
        "bottom_row_panels": 5
      }
    }
  },
  "metadata_tracking": {
    "preserve_fields": [
      "Condition", "Injury Day", "Mouse", 
      "ROI", "Details", "File Name"
    ],
    "batch_definition": ["Injury Day", "Mouse"],
    "stratification_fields": ["Details"],
    "replicate_column": "Mouse",
    "timepoint_column": "Injury Day",
    "condition_column": "Condition",
    "region_column": "Details"
  }
}